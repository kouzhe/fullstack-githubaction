name: CD - Deploy to AWS S3

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  AWS_REGION: ap-southeast-2  # AWSåŒºåŸŸï¼ˆæ‚‰å°¼ï¼‰

jobs:
  # éƒ¨ç½²åˆ°S3
  deploy:
    name: Deploy to S3
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # 2. æ˜¾ç¤ºè¦éƒ¨ç½²çš„æ–‡ä»¶
      - name: æ˜¾ç¤ºé¡¹ç›®æ–‡ä»¶
        run: |
          echo "ğŸ“¦ å‡†å¤‡éƒ¨ç½²ä»¥ä¸‹æ–‡ä»¶ï¼š"
          ls -la
          echo ""
          echo "âœ… æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
      
      # 3. é…ç½®AWSå‡­è¯
      - name: é…ç½®AWSå‡­è¯
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # 4. ä¸Šä¼ æ–‡ä»¶åˆ°S3
      - name: ä¸Šä¼ åˆ°S3
        run: |
          echo "ğŸš€ å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°S3..."
          aws s3 sync . s3://${{ secrets.S3_BUCKET_NAME }}/ \
            --delete \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "*.md"
          echo "âœ… ä¸Šä¼ å®Œæˆï¼"
      
      # 5. æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
      - name: éƒ¨ç½²å®Œæˆ
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“Š éƒ¨ç½²ä¿¡æ¯ï¼š"
          echo "  Bucket: ${{ secrets.S3_BUCKET_NAME }}"
          echo "  åŒºåŸŸ: ${{ env.AWS_REGION }}"
          echo "  æ—¶é—´: $(date)"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€:"
          echo "  http://${{ secrets.S3_BUCKET_NAME }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"

  # æ£€æŸ¥ç½‘ç«™æ˜¯å¦æ­£å¸¸
  check:
    name: Check Website
    runs-on: ubuntu-latest
    needs: deploy  # ç­‰å¾…deployå®Œæˆ
    
    steps:
      - name: æ£€æŸ¥ç½‘ç«™
        run: |
          echo "ğŸ” æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯ä»¥è®¿é—®..."
          sleep 5  # ç­‰å¾…5ç§’è®©éƒ¨ç½²ç”Ÿæ•ˆ
          
          URL="http://${{ secrets.S3_BUCKET_NAME }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
          
          # æ£€æŸ¥ç½‘ç«™çŠ¶æ€
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL)
          
          if [ $STATUS -eq 200 ]; then
            echo "âœ… ç½‘ç«™æ­£å¸¸ï¼(HTTP $STATUS)"
            echo "ğŸŒ è®¿é—®: $URL"
          else
            echo "âŒ ç½‘ç«™å¼‚å¸¸ (HTTP $STATUS)"
            exit 1
          fi
